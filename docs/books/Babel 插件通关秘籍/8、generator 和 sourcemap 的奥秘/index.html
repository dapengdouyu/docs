<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Dapeng的博客 Blog RSS Feed">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7dda2565ba246ecd62878c13153e2941",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="IXU12YQUjF">
<link rel="preconnect" href="https://hmcdn.baidu.com">
<link rel="stylesheet" href="https://cansiny.oss-cn-shanghai.aliyuncs.com/assets/fonts.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">8、generator 和 sourcemap 的奥秘 - Dapeng的博客</title><meta data-react-helmet="true" property="og:url" content="https://dapengdouyu.github.io/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="8、generator 和 sourcemap 的奥秘 - Dapeng的博客"><meta data-react-helmet="true" name="description" content="AST 转换完之后就到了 generate 阶段，genenrate 是怎么生成目标代码和 sourcemap 的呢？sourcemap 有啥作用呢？"><meta data-react-helmet="true" property="og:description" content="AST 转换完之后就到了 generate 阶段，genenrate 是怎么生成目标代码和 sourcemap 的呢？sourcemap 有啥作用呢？"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://dapengdouyu.github.io/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5ab70b72.css">
<link rel="preload" href="/assets/js/runtime~main.b2d0e262.js" as="script">
<link rel="preload" href="/assets/js/main.82ba9a71.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">DAPENG</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">博客</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags/java-script">JavaScript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">前端</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/program/javascript/index">Javascript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">阅读</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/books/Babel 插件通关秘籍/index">Babel 插件通关秘籍</a></li></ul></div><a href="https://github.com/dapengdouyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Babel 插件通关秘籍</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/index">babel 小册</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/1、Babel 的介绍">1、Babel 的介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/2、Babel 的编译流程">2、Babel 的编译流程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/3、Babel 的 AST">3、Babel 的 AST</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/4、Babel 的 api">4、Babel 的 api</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/5、实战案例：插入函数调用参数">5、实战案例：插入函数调用参数</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/6、js parser 的历史">6、js parser 的历史</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/7、traverse 的 visitor 和 path">7、traverse 的 visitor 和 path</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘">8、generator 和 sourcemap 的奥秘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/9、code-frame 和代码高亮原理">9、code-frame 和代码高亮原理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/10、Babel 插件和 preset">10、Babel 插件和 preset</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/11、Babel 插件的单元测试">11、Babel 插件的单元测试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/12、Babel 的内置功能（上）">12、Babel 的内置功能（上）</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/13、Babel 的内置功能（下）">13、Babel 的内置功能（下）</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/14、实战案例：自动埋点">14、实战案例：自动埋点</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/15、实战案例: 自动国际化">15、实战案例: 自动国际化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/16、实战案例:自动生成 api 文档">16、实战案例:自动生成 api 文档</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/17、实战案例: linter">17、实战案例: linter</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/18、实战案例: type checker">18、实战案例: type checker</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/19、实战案例: 压缩混淆">19、实战案例: 压缩混淆</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/20、实战案例: js 解释器">20、实战案例: js 解释器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/21、实战案例: 模块遍历器">21、实战案例: 模块遍历器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/22、Babel Macros">22、Babel Macros</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/23、手写 Babel：思路篇">23、手写 Babel：思路篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/24、手写 Babel： parser 篇">24、手写 Babel： parser 篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/25、手写 Babel： traverse 篇">25、手写 Babel： traverse 篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/26、手写 Babel： traverse -- path篇">26、手写 Babel： traverse -- path篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/27、手写 Babel： traverse -- scope篇">27、手写 Babel： traverse -- scope篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/28、手写 Babel： generator篇">28、手写 Babel： generator篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/29、手写 Babel： core篇">29、手写 Babel： core篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/30、手写 Babel： cli篇">30、手写 Babel： cli篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/31、手写 Babel： 总结">31、手写 Babel： 总结</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/32、工具介绍：vscode debugger 的使用">32、工具介绍：vscode debugger 的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/Babel 插件通关秘籍/33、小册总结">33、小册总结</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">MySQL 是怎样运行的：从根儿上理解 MySQL</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React Hooks 与 Immutable 数据流实战</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React 组合式开发实践：打造企业管理系统五大核心模块</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React实战：设计模式和最佳实践</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Taro 多端开发实现原理与项目实战</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">前端性能优化原理与实践</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">前端面试之道</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">微信小程序开发入门：从 0 到 1 实现天气小程序</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">深入浅出TypeScript：从基础知识到类型编程</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">8、generator 和 sourcemap 的奥秘</h1></header><p>AST 转换完之后就到了 generate 阶段，genenrate 是怎么生成目标代码和 sourcemap 的呢？sourcemap 有啥作用呢？</p><p>本节就来探索一下 generate 的奥秘。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="generate"></a>generate<a class="hash-link" href="#generate" title="Direct link to heading">#</a></h2><p>generate 是把 AST 打印成字符串，是一个从根节点递归打印的过程，对不同的 AST 节点做不同的处理，在这个过程中把抽象语法树中省略掉的一些分隔符重新加回来。</p><p>比如 while 语句 WhileStatement 就是先打印 while，然后打印一个空格和 &#x27;(&#x27;，然后打印 node.test 属性的节点，然后打印 &#x27;)&#x27;，之后打印 block 部分</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04d9befc0ad54eb2822d3fb086a50cd7~tplv-k3u1fbpfcp-watermark.image"></p><p>比如条件表达式 ConditionExpression 就是分别打印 node.test、node.consequent、node.alternate 属性，中间插入 <code>?</code> <code>:</code> 和空格。</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47676f74a3a944c190fd51ecedbee9d4~tplv-k3u1fbpfcp-watermark.image"></p><p>通过这样的方式递归打印整个 AST，就可以生成目标代码。</p><p>\@babel/generator 的 <a href="https://github.com/babel/babel/tree/main/packages/babel-generator/src/generators" target="_blank" rel="noopener noreferrer">src/generators</a> 下定义了每一种AST节点的打印方式，感兴趣的话可以去看一下。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sourcemap"></a>sourcemap<a class="hash-link" href="#sourcemap" title="Direct link to heading">#</a></h2><p>我们知道可以在 generate 的时候选择是否生成 sourcemap，那为什么要生成 sourcemap 呢？</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sourcemap-的作用"></a>sourcemap 的作用<a class="hash-link" href="#sourcemap-的作用" title="Direct link to heading">#</a></h4><p>babel 对源码进行了修改，生成的目标代码可能改动很大，如果直接调试目标代码，可能很难定位到源码。所以需要一种自动关联源码的方式，就是 sourcemap。</p><p>我们平时用 sourcemap 主要用两个目的：</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="调试代码时定位到源码"></a>调试代码时定位到源码<a class="hash-link" href="#调试代码时定位到源码" title="Direct link to heading">#</a></h5><p>chrome、firefox 等浏览器支持在文件末尾加上<a href="https://developer.mozilla.org/zh-CN/docs/Tools/Debugger/How_to/Use_a_source_map" target="_blank" rel="noopener noreferrer">一行注释</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//# sourceMappingURL=http://example.com/path/to/your/sourcemap.map</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>可以通过 url 的方式或者转成 base64 内联的方式来关联 sourcemap。调试工具（浏览器、vscode 等会自动解析 sourcemap，关联到源码。这样打断点、错误堆栈等都会对应到相应源码。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="线上报错定位到源码"></a>线上报错定位到源码<a class="hash-link" href="#线上报错定位到源码" title="Direct link to heading">#</a></h5><p>开发时会使用 sourcemap 来调试，但是生产可不会，要是把 sourcemap 传到生产算是大事故了。但是线上报错的时候确实也需要定位到源码，这种情况一般都是单独上传 sourcemap 到错误收集平台。</p><p>比如 sentry 就提供了一个 sentry webpack plugin 支持在打包完成后把 sourcemap 自动上传到 sentry 后台，然后把本地 sourcemap 删掉。还提供了 sentry-cli 让用户可以手动上传。</p><p>平时我们至少在这两个场景（开发时调试源码，生产时定位错误）下会用到 sourcemap。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sourcemap的格式"></a>sourcemap的格式<a class="hash-link" href="#sourcemap的格式" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">　　version </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   file</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;out.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sourceRoot </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;foo.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar.js&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   names</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;src&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;maps&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;are&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fun&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   mappings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;AAgBC,SAAQ,CAAEA&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>比如上面就是一个 sourcemap 文件，对应字段的含义如下：</p><ul><li><p>version：source map的版本，目前为3。</p></li><li><p>file：转换后的文件名。</p></li><li><p>sourceRoot：转换前的文件所在的目录。如果与转换前的文件在同一目录，该项为空。</p></li><li><p>sources：转换前的文件。该项是一个数组，因为可能是多个源文件合并成一个目标文件。</p></li><li><p>names：转换前的所有变量名和属性名，把所有变量名提取出来，下面的 mapping 直接使用下标引用，可以减少体积。</p></li><li><p>mappings：转换前代码和转换后代码的映射关系的集合，用分号代表一行，每行的 mapping 用逗号分隔。</p></li></ul><p>重点看 mappping 部分</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">　　mappings</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;AAAAA,BBBBB;;;;CCCCC,DDDDD&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>每一个分号 <code>;</code> 表示一行，多个空行就是多个 <code>;</code>，mapping 通过 <code>,</code> 分割。</p><p>mapping有五位：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> 第一位是目标代码中的列数</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 第二位是源码所在的文件名</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 第三位是源码对应的行数</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 第四位是源码对应的列数</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 第五位是源码对应的 names，不一定有</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>每一位是通过 VLQ 编码的，一个字符就能表示行列数，具体 VLQ 的编码方式感兴趣可以查一下相关资料。</p><p>sourcemap 通过 <code>names</code> 和 <code>;</code> 的设计省略掉了一些变量名和行数所占的空间，又通过 VLQ 编码使得一个字符就可以表示行列数等信息。通过不大的空间占用完成了源码到目标代码的映射。</p><p><strong>那么 sourcemap 的源码和目标代码的行列数是怎么来的呢？</strong></p><p>其实我们在 parse 的时候就在 AST 节点中保存了 loc 属性，这就是源码中的行列号，在后面 transform 的过程中，并不会去修改它，所以转换完以后节点中仍然保留有源码中的行列号信息，在 generate 打印成目标代码的时候会计算出新的行列号，这样两者关联就可以生成 sourcemap。</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a1f09b8512db4269ab9fdad56cfeb36b~tplv-k3u1fbpfcp-watermark.image"></p><p>具体生成 sourcemap 的过程是用 mozilla 维护的 <a href="https://www.npmjs.com/package/source-map" target="_blank" rel="noopener noreferrer">source-map</a> 这个包，其他工具做 sourcemap 的解析和生成也是基于这个包。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="soruce-map"></a>soruce-map<a class="hash-link" href="#soruce-map" title="Direct link to heading">#</a></h2><p><a href="https://www.npmjs.com/package/source-map" target="_blank" rel="noopener noreferrer">source-map</a> 可以用于生成和解析 sourcemap，需要手动操作 sourcemap 的时候可以用。我们通过它的 api 来感受下 babel 是怎么生成 sourcemap 的。</p><p>source-map 暴露了 SourceMapConsumer、SourceMapGenerator、SourceNode 3个类，分别用于消费 sourcemap、生成 sourcemap、创建源码节点。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="生成-sourcemap"></a>生成 sourcemap<a class="hash-link" href="#生成-sourcemap" title="Direct link to heading">#</a></h5><p>生成 sourcemap 的流程是：</p><ol><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">创建一个 </span><span class="token maybe-class-name">SourceMapGenerator</span><span class="token plain"> 对象</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">通过 addMapping 方法添加一个映射</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">通过 toString 转为 sourcemap 字符串</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>var map = new SourceMapGenerator({
file: &quot;source-mapped.js&quot;
});</p><p>map.addMapping({
generated: {
line: 10,
column: 35
},
source: &quot;foo.js&quot;,
original: {
line: 33,
column: 2
},
name: &quot;christopher&quot;
});</p><p>console.log(map.toString());
// &#x27;{&quot;version&quot;:3,&quot;file&quot;:&quot;source-mapped.js&quot;,
//   &quot;sources&quot;:[&quot;foo.js&quot;],&quot;names&quot;:[&quot;christopher&quot;],&quot;mappings&quot;:&quot;;;;;;;;;;mCAgCEA&quot;}&#x27;</p></li></ol><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="消费sourcemap"></a>消费sourcemap<a class="hash-link" href="#消费sourcemap" title="Direct link to heading">#</a></h5><p>SourceMapConsumer.with 的回调里面可以拿到 consumer 的 api，调用 originalPositionFor 和 generatedPositionFor 可以分别用目标代码位置查源码位置和用源码位置查目标代码位置。还可以通过 eachMapping 遍历所有 mapping，对每个进行处理。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rawSourceMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  file</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;min.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  names</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;baz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;n&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;one.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;two.js&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sourceRoot</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://example.com/www/js/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  mappings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CAAC,IAAI,IAAM,SAAUA,GAClB,OAAOC,IAAID;CCDb,IAAI,IAAM,SAAUE,GAClB,OAAOA&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> whatever </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token maybe-class-name">SourceMapConsumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">with</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rawSourceMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token parameter">consumer</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 目标代码位置查询源码位置</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">originalPositionFor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    line</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    column</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// { source: &#x27;http://example.com/www/js/two.js&#x27;,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//   line: 2,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//   column: 10,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//   name: &#x27;n&#x27; }</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 源码位置查询目标代码位置</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">generatedPositionFor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://example.com/www/js/two.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    line</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    column</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// { line: 2, column: 28 }</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 遍历 mapping</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">eachMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">computeWhatever</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>babel 就是用这些 api 来生成 sourcemap 的。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p>这一节我们探索了下 generator 和 sourcemap 的原理，generate 就是递归打印 AST 成字符串，在递归打印的过程中会根据源码位置和计算出的目标代码的位置来生成 mapping，加到 sourcemap 中。 sourcemap 是源码和目标代码的映射，用于开发时调试源码和生产时定位线上错误。 babel 通过 source-map 这个包来生成的 sourcemap，我们使用了下 source-map 包的 api，对 sourcemap 的生成和消费有了一个直观的认识。</p><p>学完这一节之后，我们知道了 AST 是怎么生成目标代码和 sourcemap的，加上前两节的内容，把整个 babel 的编译流程串联了起来。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/dapengdouyu/docs/tree/master/docs/books/Babel 插件通关秘籍/8、generator 和 sourcemap 的奥秘.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-10-11T06:28:32.000Z">10/11/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/books/Babel 插件通关秘籍/7、traverse 的 visitor 和 path"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 7、traverse 的 visitor 和 path</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/books/Babel 插件通关秘籍/9、code-frame 和代码高亮原理"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">9、code-frame 和代码高亮原理 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#generate" class="table-of-contents__link">generate</a></li><li><a href="#sourcemap" class="table-of-contents__link">sourcemap</a></li><li><a href="#soruce-map" class="table-of-contents__link">soruce-map</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 dapeng (张亚鹏) Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b2d0e262.js"></script>
<script src="/assets/js/main.82ba9a71.js"></script>
</body>
</html>