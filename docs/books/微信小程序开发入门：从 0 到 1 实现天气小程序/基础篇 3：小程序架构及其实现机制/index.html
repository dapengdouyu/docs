<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.7">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Dapeng&#39;s blog RSS Feed">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7dda2565ba246ecd62878c13153e2941",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="IXU12YQUjF">
<link rel="preconnect" href="https://hmcdn.baidu.com">
<link rel="stylesheet" href="https://cansiny.oss-cn-shanghai.aliyuncs.com/assets/fonts.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">基础篇 3：小程序架构及其实现机制 - Dapeng的博客</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://dapengdouyu.github.io/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="基础篇 3：小程序架构及其实现机制 - Dapeng的博客"><meta data-react-helmet="true" name="description" content="小程序 VS HTML5"><meta data-react-helmet="true" property="og:description" content="小程序 VS HTML5"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://dapengdouyu.github.io/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.104602c4.css">
<link rel="preload" href="/assets/js/runtime~main.fe208008.js" as="script">
<link rel="preload" href="/assets/js/main.b2c4784f.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">DAPENG</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/">博客</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags/java-script">JavaScript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">前端</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/program/javascript/index">Javascript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">阅读</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/books/Babel 插件通关秘籍/index">Babel 插件通关秘籍</a></li></ul></div><a href="https://github.com/dapengdouyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Babel 插件通关秘籍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">MySQL 是怎样运行的：从根儿上理解 MySQL</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React Hooks 与 Immutable 数据流实战</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React 组合式开发实践：打造企业管理系统五大核心模块</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React实战：设计模式和最佳实践</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Taro 多端开发实现原理与项目实战</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">前端性能优化原理与实践</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">前端面试之道</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">微信小程序开发入门：从 0 到 1 实现天气小程序</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/index">index</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 1：小程序开发基础知识">基础篇 1：小程序开发基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 2：小程序云开发基础知识">基础篇 2：小程序·云开发基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制">基础篇 3：小程序架构及其实现机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 1：小程序开发环境搭建">实战篇 1：小程序开发环境搭建</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 2：新鲜天气小程序简介">实战篇 2：新鲜天气小程序简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 3：天气页面样式布局开发">实战篇 3：天气页面样式布局开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 4：天气页面数据获取和交互实现">实战篇 4：天气页面数据获取和交互实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 5：为天气页面制作雨雪效果的粒子系统">实战篇 5：为天气页面制作雨雪效果的粒子系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 6：心情签到页面开发">实战篇 6：心情签到页面开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 7：对小程序进行优化">实战篇 7：对小程序进行优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 8：小程序调试技巧和上线发布">实战篇 8：小程序调试技巧和上线发布</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/开篇：微信小程序概述">开篇：微信小程序概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/总结与拓展">总结与拓展</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">正则表达式</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">深入浅出TypeScript：从基础知识到类型编程</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>基础篇 3：小程序架构及其实现机制</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="小程序-vs-html5">小程序 VS HTML5<a aria-hidden="true" class="hash-link" href="#小程序-vs-html5" title="Direct link to heading">​</a></h2><p>小程序并不是 HTML5 应用，而是更偏向于传统的 CS 架构，它是基于<strong>数据驱动</strong>的模式，一切皆组件（视图组件）。下面是小程序与普通 Web App 的对比。</p><ul><li>普通 HTML5 都是执行在浏览器的宿主环境，浏览器提供 <code>window</code>、<code>document</code> 等 BOM 对象，但小程序没有 <code>window</code>、<code>document</code>，它更像是一个类似 Node.js 的宿主环境；因此在小程序内不能使用 <code>document.querySelector</code> 这类 DOM 选择器，也不支持 <code>XMLHttpRequest</code>、<code>location</code>、<code>localStorage</code> 等这些浏览器提供的 API，只能使用小程序自己实现的 API</li><li>小程序并非是直接通过 URL 访问的，而是通过信道服务进行通信和会话管理，所以它不支持 Cookie 存储，同时访问资源使用 <code>wx.request</code> 则不存在跨域的问题</li><li>小程序在 JavaScript 的模块化上支持 CommonJS，通过 require 加载，跟 Node.js 类似</li><li>小程序的页面样式完全继承了 CSS 的语法，但是在选择器上面会少一些，布局支持 flex 布局</li><li>小程序的整体框架采用面向状态编程方式，状态管理从 API 来看采用类似 Redux 的设计方式；单向数据绑定方式，当 View 在 Action 操作后，只能通过 Action 的业务处理来更新 View</li></ul><p>页面组件模块上，WXML 提供了一整套的「自定义 UI 组件标签」，有些组件实际是 HTML5 实现的，有些组件为了解决权限、性能和适配等问题实际是 Native 实现的（如 map、input、canvas、video）。</p><p>笔者在 Android 手机上通过「设置 -&gt; 开发人员选项 -&gt; 显示布局界限」选择<strong>显示布局界限</strong>之后，打开小程序的页面会看到 Native 的边框，如果是 Native 组件则会展现出来，下面是今日头条小程序的截图。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313734e6618f3?w=1079&amp;h=1920&amp;f=jpeg&amp;s=371788"></p><p>而使用 <a href="https://x5.tencent.com/" target="_blank" rel="noopener noreferrer">X5 内核</a>的 inspect 版本（X5 内核 debug 功能在 <a href="https://juejin.im/book/5b70f101e51d456669381803/section/5b70f888f265da27e36ef112" target="_blank" rel="noopener noreferrer">12 节真机调试技巧</a>部分有详细介绍），打开 Chrome 的远程调试，看到当前页面如下图所示。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313705cbd8524?w=960&amp;h=889&amp;f=png&amp;s=507229"></p><p>从图中看到，今日头条的小程序顶部导航区域是 Native 组件（会显示布局界限），而底部没有边框，在 Chrome 内发现实际为 webview 的页面实现。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="小程序架构解密">小程序架构解密<a aria-hidden="true" class="hash-link" href="#小程序架构解密" title="Direct link to heading">​</a></h2><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/16531377b0ecbfc4?w=1024&amp;h=768&amp;f=jpeg&amp;s=270403"></p><p>小程序架构如上图所示，分为视图层和逻辑层，视图层是在 WebView 内渲染，逻辑层则有 JavaScriptCore 来渲染；其中视图层可以多个（考虑到整体性能，最多可以 5 个），逻辑层则全局只有一个（实际通过开启 X5 内核另起一个 JavascriptCore 线程）。</p><p>视图层是 WebView，逻辑层为 JavaScriptCore，证据如下：使用 Android 手机，开启 X5 内核 debug 之后，在 Chrome inspect 中可以看到下图所示的内容。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/1653137a557f6bbc?w=927&amp;h=439&amp;f=png&amp;s=87662"></p><p>在小程序内，视图层负责页面渲染，逻辑层负责逻辑处理、全局状态管理、请求和接口调用。逻辑层在小程序中称为 <code>APP Service</code>，视图层称为 <code>View</code>。</p><p>逻辑层和视图层通过微信的 <code>JSBridge</code> 来实现通信的，逻辑层数据变化通过 <code>JSBridge</code> 通知视图层，触发视图层更新；当视图层触发事件，则继续通过 <code>JSBridge</code> 将事件通知到逻辑层做处理，如此交互进行。</p><p><code>JSBridge</code> 在三个环境（开发者工具、iOS 和 Android）中实现机制不同，在调用 Native 能力时主要使用 <code>invokeHandler</code>：</p><ul><li>开发者工具：通过 <code>window.postMessage</code> 来封装</li><li>iOS：通过 WKWebview 的 <code>window.webkit.messageHandlers.invokeHandler.postMessage</code></li><li>Android：通过 <code>WeixinJSCore.invokeHandler</code></li></ul><p>在消息分发的时候，则使用 <code>publishHandler</code>：</p><ul><li>开发者工具：通过 <code>addEventListener(&#x27;message&#x27;)</code> 来监听消息，然后处理分发</li><li>iOS：使用 WKWebview 的 <code>window.webkit.messageHandlers.publishHandler.postMessage</code></li><li>Android：通过 <code>WeixinJSCore.publishHandler</code></li></ul><p>其中，Android 的 <code>WeixinJSCore</code> 是 X5 内核暴露出来的对象，其作为 <code>window</code> 对象的一个属性，提供一些供 JavaScript 调用的能力。</p><p>这部分可以在开发者工具或者 X5 内核 debug 模式下，找到 <code>WAService.js</code>（代码笔者放到了<a href="https://gist.github.com/ksky521/590fdffcff203ee9fa83cb188b4a664b" target="_blank" rel="noopener noreferrer">这个 Gist</a> 上，方便大家查看） 看到：</p><p>WeixinJSBridge 提供的方法有 <code>invoke</code>、<code>publish</code> 和 <code>subscribe</code> 等，<code>invoke</code> 就是关键的调用 Native 端能力的方法，<code>publish</code> 是消息分发的方法。注意下图的 <code>invoke</code> 实际是来自<code>y</code>，<code>publish</code> 来自 <code>w</code>，<code>e</code> 为 <code>window</code>。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/23/16565a664eee46a3?w=457&amp;h=619&amp;f=png&amp;s=70984"></p><p><code>y</code> 的实现最后调用了<code>g</code>，<code>w</code> 的实现最后调用了<code>_</code>。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/23/16565a9a64c86a08?w=392&amp;h=440&amp;f=png&amp;s=56038"></p><p>继续查找<code>g</code>、<code>_</code> 的实现，发现 <code>g</code>、<code>_</code> 最后都调用了 <code>d</code> 和 <code>f</code> 的方法（显现了关键字<code>invokeHandler</code>、<code>publishHandler</code>）。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/23/16565aad2c8758ef?w=827&amp;h=462&amp;f=png&amp;s=71454"></p><p>继续查找，发现 <code>d</code> 和 <code>f</code> 分别是来自 <code>window.webkit</code>、<code>window.WeixinJSCore</code>。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/23/16565ad03ce850c6?w=257&amp;h=82&amp;f=png&amp;s=12861"></p><p>因为在一个小程序中可以打开多个视图层（webview），要保证发送的消息准确送到每个具体的 webview 中，需要通过每个 webview 唯一标识 <code>webviewId</code> 来实现。发送消息时，携带 <code>webviewId</code>，然后逻辑层处理完对应的逻辑，如果需要通知或者执行对应 webview 的代码，则可以通过 <code>webviewId</code> 找到对应的 webview，下发通知。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="小程序生命周期">小程序生命周期<a aria-hidden="true" class="hash-link" href="#小程序生命周期" title="Direct link to heading">​</a></h2><p>小程序生命周期包括应用的生命周期（逻辑层 App Service）和页面的生命周期（视图层 View），两者支持的事件不同，详见官方文档中的这张配图。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/16531394a3c8fe1f?w=662&amp;h=1014&amp;f=png&amp;s=45267"></p><p>掌握了上面小程序实现原理的内容，再来看小程序的生命周期就很好理解了。</p><p>小程序启动时，会同时启动两个线程，一个负责页面渲染的 WebView（实际不止一个，后面讲解），一个负责逻辑的 JavaScriptCore。逻辑层初始化后会将初始化数据（app.js 中的 global data）通过 JSBridge 传递给渲染层进行渲染，渲染层 WebView 页面渲染完之后又会跟逻辑层通信。</p><p>理解了小程序架构和启动流程，小程序整个生命周期的流程只需要对着上面的流程图就可以很容易理解。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="小程序为什么感觉快">小程序为什么感觉快<a aria-hidden="true" class="hash-link" href="#小程序为什么感觉快" title="Direct link to heading">​</a></h2><p>小程序在体验上不仅仅页面流畅，而且点击之后，页面跳转也会比普通的 HTML5 要快很多，这是因为小程序的视图层做了预加载处理。下图是通过 X5 内核开启 inspect 版本之后，在 Chrome 中看到的手机 WebView 的页面情况。小程序选择今日头条，打开了两个页面（热点新闻列表和某条新闻详情），但实际在 Chrome 中看到的 WebView 页面总是比真实打开的页面要多一个，这个多出来的隐藏 WebView 就是提前初始化预热的，方便打开下一个小程序页面来使用，这样就节省了 WebView 初始化的时间，从而大幅提升了跳页效率。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/16531399500bca20?w=1433&amp;h=760&amp;f=jpeg&amp;s=228402"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="小程序-wxml-是怎么转成-html-的">小程序 WXML 是怎么转成 HTML 的<a aria-hidden="true" class="hash-link" href="#小程序-wxml-是怎么转成-html-的" title="Direct link to heading">​</a></h2><p>小程序的视图层最终是渲染在一个 webview 中的，通过下图就可以看到我们在 WXML 中写的 <code>view</code>、<code>icon</code>、<code>text</code> 等标签最终会转换成 <code>wx-*</code> 等标签。</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/1653139d01fde2a4?w=1127&amp;h=877&amp;f=png&amp;s=436706"></p><p>那么 WXML 到 HTML 的过程发生了什么呢？</p><p>首先，WXML 写完之后经过编译工具 <code>wcc</code> 转成可执行的 JS，下面的命令可以将某个页面转为 JS：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">wcc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">wxml</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p><strong>TIPS：</strong> <code>wcc</code> 和 <code>wcsc</code> 是小程序的 WXML 和 WXSS 的编译工具，是二进制文件，在 macOS 中可以在<code>/Applications/wechatwebdevtools.app/Contents/Resources/package.nw/js/vendor/</code> 路径中找到（应用 → 右键微信开发者工具 → 查看包文件）</p></blockquote><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313e0a87d209f?w=1764&amp;h=1096&amp;f=png&amp;s=413336"></p><p>这个 JS 里面有个重要的函数是 <code>$gwx</code>：</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313e2c44a689c?w=981&amp;h=392&amp;f=png&amp;s=248171"></p><p>这个 JS 主要接收一个 <code>path</code> 将 <code>path</code> 的页面转换成一个 Virtual DOM：</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313e4c84b0937?w=341&amp;h=455&amp;f=png&amp;s=44563"></p><p>在这个 VDOM 结构里面就会找到以<code>wx-*</code> 开头的 tag，有了这个 VDOM 结构，就可以使用对应的 tag 创建 HTML 片段了。</p><p>整个流程梳理如下：</p><p><img src="https://user-gold-cdn.xitu.io/2018/8/13/165313e72ea7a43a?w=794&amp;h=97&amp;f=png&amp;s=26808"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="小结">小结<a aria-hidden="true" class="hash-link" href="#小结" title="Direct link to heading">​</a></h2><p>本节重点介绍了小程序和普通的 HTML5 有什么区别，从小程序底层机制上来说明小程序是如何最终展现在 WebView 界面上的。本节涉及较多的源码和反编译技巧，对于初学者来说只需要了解微信小程序由逻辑层和视图层两个不同的线程进行交互而形成，而视图层是通过将 WXML 转换成 JS，最终由 JS 生成 HTML 片段放在 WebView 中显示的。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dapengdouyu/docs/tree/master/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 3：小程序架构及其实现机制.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-10-11T06:28:32.000Z">10/11/2021</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/基础篇 2：小程序云开发基础知识"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->基础篇 2：小程序·云开发基础知识</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/books/微信小程序开发入门：从 0 到 1 实现天气小程序/实战篇 1：小程序开发环境搭建"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">实战篇 1：小程序开发环境搭建<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#小程序-vs-html5" class="table-of-contents__link toc-highlight">小程序 VS HTML5</a></li><li><a href="#小程序架构解密" class="table-of-contents__link toc-highlight">小程序架构解密</a></li><li><a href="#小程序生命周期" class="table-of-contents__link toc-highlight">小程序生命周期</a></li><li><a href="#小程序为什么感觉快" class="table-of-contents__link toc-highlight">小程序为什么感觉快</a></li><li><a href="#小程序-wxml-是怎么转成-html-的" class="table-of-contents__link toc-highlight">小程序 WXML 是怎么转成 HTML 的</a></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 dapeng (张亚鹏) 京ICP备20028300号</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fe208008.js"></script>
<script src="/assets/js/main.b2c4784f.js"></script>
</body>
</html>