<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Dapeng的博客 Blog RSS Feed">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7dda2565ba246ecd62878c13153e2941",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="IXU12YQUjF">
<link rel="preconnect" href="https://hmcdn.baidu.com">
<link rel="stylesheet" href="https://cansiny.oss-cn-shanghai.aliyuncs.com/assets/fonts.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">13、Babel 的内置功能（下） - Dapeng的博客</title><meta data-react-helmet="true" property="og:url" content="https://dapengdouyu.github.io/docs/books/babel/13、Babel 的内置功能（下）"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="13、Babel 的内置功能（下） - Dapeng的博客"><meta data-react-helmet="true" name="description" content="上一节我们学习了 babel 插件的分类、babel 的 preset、helper、runtime。babel 的功能基本都建立在这些之上，babel 6 到 babel 7 还有未来的 babel 8 基于这些做了不同的设计。"><meta data-react-helmet="true" property="og:description" content="上一节我们学习了 babel 插件的分类、babel 的 preset、helper、runtime。babel 的功能基本都建立在这些之上，babel 6 到 babel 7 还有未来的 babel 8 基于这些做了不同的设计。"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://dapengdouyu.github.io/docs/books/babel/13、Babel 的内置功能（下）"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/babel/13、Babel 的内置功能（下）" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dapengdouyu.github.io/docs/books/babel/13、Babel 的内置功能（下）" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5ab70b72.css">
<link rel="preload" href="/assets/js/runtime~main.3c5dc381.js" as="script">
<link rel="preload" href="/assets/js/main.055808b2.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpg" alt="DAPENG" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">DAPENG</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">博客</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags/java-script">JavaScript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">前端</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/program/javascript/index">Javascript</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">阅读</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/books/babel/index">babel</a></li></ul></div><a href="https://github.com/dapengdouyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">13、Babel 的内置功能（下）</h1></header><p>上一节我们学习了 babel 插件的分类、babel 的 preset、helper、runtime。babel 的功能基本都建立在这些之上，babel 6 到 babel 7 还有未来的 babel 8 基于这些做了不同的设计。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="从目标语言版本到目标浏览器"></a>从目标语言版本到目标浏览器<a class="hash-link" href="#从目标语言版本到目标浏览器" title="Direct link to heading">#</a></h2><p>我们通过插件完成了各种代码（es next、proposal、typescript/flow/jsx...）到 es5 的转换，然后把不同的转换插件封装到不同的 preset （preset-env、preset-typescript、preset-react...）里，而且还把插件内部的公共逻辑抽成 helper 来复用，并且提供了 runtime 包用于注入运行时的 api。这样已经能够达到不同语法的代码转 es5 同时对 api 进行 polyfill 的目标了。 但是这样就够了么？还有哪些问题？</p><ul><li><p>我们现在是指定了目标环境支持 es5，那么如果目标环境支持了部分 es6（es2015）、es7（es2016）等，那岂不是做了很多无用功？</p></li><li><p>preset-es2015、preset-es2016、preset-stage-x 这种 preset 跟随版本走的，那岂不是经常变，得经常改这些 preset 的内容 （当某个提案从 stage 0 进入到 stage 1 就得改下），这样多累啊，而且用户也得经常改配置，stage-x 对他来说是个黑盒，不靠谱。</p></li></ul><p><strong>怎么解决这些问题呢？</strong></p><p>babel6 到 babel7 的变化给出了答案：</p><p>preset 经常变的问题通过废弃 stage-x 和 es20xx 的 preset，改成 preset-env 和 plugin-proposal-xx 的方式来解决， 这样不需要指定用的是 es 几了，默认会全部支持，包含<a href="https://github.com/babel/babel/blob/master/packages/babel-compat-data/scripts/data/plugin-features.js" target="_blank" rel="noopener noreferrer">所有的已经是语言标准特性的 transform plugin</a>， 而且 stage-x 有哪些不再是黑盒，用户想用啥还在 proposal 的特性直接显示引入对应的 plugin。</p><p>多转换了目标环境支持的语法或 api 的问题是要解决转换的精准度的问题，可是目标环境那么多，浏览器版本、node 版本、electron 版本每年都在变，怎么做到精准？</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="comat-table"></a>comat-table<a class="hash-link" href="#comat-table" title="Direct link to heading">#</a></h5><p>答案是 compat-table 的数据，compat-table 提供了每个特性在不同环境中的支持版本。</p><p>比如<a href="https://github.com/kangax/compat-table/blob/gh-pages/data-es6.js#L1864-L1904" target="_blank" rel="noopener noreferrer">默认参数</a>这个 es2015 的特性，可以查到在 babel6 且 corejs2 以上支持，在 chrome 中是 49 以上支持，chrome48 中还是实验特性，在 node6 以上支持，等等。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f1adc5fc56d4ec1ad4cb757eb3356c5~tplv-k3u1fbpfcp-watermark.image"></p><p>光是这些数据还不够，electron 有自己的版本，要支持 electron 得需要 electron 版本和它用的 chromuim 的版本的对应关系。</p><p>万幸有 electron-to-chromium 这个项目，它维护了 <a href="https://github.com/Kilian/electron-to-chromium/blob/master/full-versions.js" target="_blank" rel="noopener noreferrer">electron 版本到 chromium 版本的映射关系</a>。</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87e37c9049544f429cd2a48afb434a81~tplv-k3u1fbpfcp-watermark.image"></p><p>也可以反过来查询 <a href="https://github.com/Kilian/electron-to-chromium/blob/master/full-chromium-versions.js" target="_blank" rel="noopener noreferrer">chromium 版本在哪些 electron 版本中使用</a>。</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d759abbb6a8f422aa791f6ce6e2dd918~tplv-k3u1fbpfcp-watermark.image"></p><p>有了这些数据，我们就能知道每一个特性在哪些环境的什么版本支持。</p><p>babel7 在 \@babel/compat-data 这个包里面维护了这种特性到环境支持版本的映射关系，包括 <a href="https://github.com/babel/babel/blob/main/packages/babel-compat-data/data/plugins.json" target="_blank" rel="noopener noreferrer">plugin 实现的特性的版本支持情况</a>（包括 transform 和 proposal ），也包括 <a href="https://github.com/babel/babel/blob/main/packages/babel-compat-data/data/corejs2-built-ins.json" target="_blank" rel="noopener noreferrer">corejs 所 polyfill 的特性的版本支持情况</a>。</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39ed0641db8a4547a8c857306c22e286~tplv-k3u1fbpfcp-watermark.image"></p><p>这样我们就知道每一个特性是在什么环境中支持的了，接下来只要用户指定一个环境，我们就能做到按需转换！</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="browserslist"></a>browserslist<a class="hash-link" href="#browserslist" title="Direct link to heading">#</a></h5><p>那开发者怎么指定环境呢？</p><p>让开发者写每个环境的版本是啥肯定不靠谱，这时候就要借助 browerslist 了，它提供了一个从 query （查询表达式） 到对应环境版本的转换。</p><p>比如我们可以通过 last 1 version 来查询最新的各环境的版本</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6aa23bc2102480894c72916418b3eb1~tplv-k3u1fbpfcp-watermark.image"></p><p>也可以通过 supports es6-module 查询所有支持 es module 的环境版本</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db1cf4c0f5294a268043e03e0d866327~tplv-k3u1fbpfcp-watermark.image"></p><p>具体查询的语法有很多，可以去 <a href="https://github.com/browserslist/browserslist#queries" target="_blank" rel="noopener noreferrer">browserslist 的 query 文档</a>中学习，这里就不展开了。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="babelpreset-env"></a>\@babel/preset-env<a class="hash-link" href="#babelpreset-env" title="Direct link to heading">#</a></h5><p>现在有了什么特性在什么环境版本中支持，有了可以通过 query 指定目标环境版本的工具，那么就可以上手改了，从都转成 es5 到根据目标环境确定不支持的特性，只转换这部分特性，这就是 \@babel/preset-env 做的事情。</p><p>有了 \@babel/compat-data 的数据，那么只要用户指定他的目标环境是啥就可以了，这时候可以用 browserslist 的 query 来写，比如 <code>last 1 version, &gt; 1%</code> 这种字符串，babel 会使用 brwoserslist 来把它们转成目标环境具体版本的数据。</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a318db95f7cb4f139981f2f453bdc39e~tplv-k3u1fbpfcp-watermark.image"></p><p>有了不同特性支持的环境的最低版本的数据，有了具体的版本，那么过滤出来的就是目标环境不支持的特性，然后引入它们对应的插件即可。这就是 preset-env 做的事情(按照目标环境按需引入插件)。</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ccb1144f8924fb99cc6073859289124~tplv-k3u1fbpfcp-watermark.image"></p><p>配置方式比如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;presets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;@babel/preset-env&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;targets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt; 0.25%, not dead&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这样就通过 preset-env 解决了多转换了目标环境已经支持的特性的问题。</p><p>其实 polyfill 也可以通过 targets 来过滤。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d8df3916feb4da7b445e8771e779353~tplv-k3u1fbpfcp-watermark.image"></p><p>不再手动引入 polyfill，那么怎么引入？ 当然是用 preset-env 自动引入了。但是不是默认就会启用这个功能，需要配置。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;presets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;@babel/preset-env&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;targets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt; 0.25%, not dead&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;useBuiltIns&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;usage&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token comment" style="color:#999988;font-style:italic">// or &quot;entry&quot; or &quot;false&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;corejs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>配置下 corejs 和 useBuiltIns。</p><ul><li><p>corejs 就是 babel 7 所用的 polyfill，需要指定下版本，corejs 3 才支持实例方法（比如 Array.prototype.fill ）的 polyfill。</p></li><li><p>useBuiltIns 就是使用 polyfill （corejs）的方式，是在入口处全部引入（entry），还是每个文件引入用到的（usage），或者不引入（false）。</p></li></ul><p>配置了这两个 option 就可以自动引入 polyfill 了。</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ea48ded51f04512bac80b8e4db809cb~tplv-k3u1fbpfcp-watermark.image"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="babelpreset-env-的配置"></a>\@babel/preset-env 的配置<a class="hash-link" href="#babelpreset-env-的配置" title="Direct link to heading">#</a></h4><p>这个包的配置比较多，首先我们要指定的是 targets，也就是 browserslist 的 query，这个同样可以在 .browserslistrc 的配置文件中指定（别的工具也可能用到）。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="targets"></a>targets<a class="hash-link" href="#targets" title="Direct link to heading">#</a></h5><p>targets 配啥呢？</p><p>可以配 query 或者直接指定环境版本（query 的结果也是环境版本）。</p><p>环境有这些：</p><p>chrome, opera, edge, firefox, safari, ie, ios, android, node, electron</p><p>可以指定 query：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;targets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt; 0.25%, not dead&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>也可以直接指定环境版本；</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;targets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;chrome&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;58&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;ie&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;11&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>要指定支持 es module 的环境，可以使用 query，也可以使用 esmodules option。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;targets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;esmodules&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="include--exclude"></a>include \&amp; exclude<a class="hash-link" href="#include--exclude" title="Direct link to heading">#</a></h5><p>通过 targets 的指定，babel 会自动引入<a href="https://github.com/babel/babel/blob/master/packages/babel-compat-data/scripts/data/plugin-features.js" target="_blank" rel="noopener noreferrer">一些插件</a>，但当需要手动指定要 include 或者 exclude 什么插件的时候可以使用这个 option。</p><p>不过这个只是针对 transform plugin，对于 proposal plugin，要在 plugins的 option 单独引入。</p><p>一般情况下并不需要单独 include 啥，用 babel 根据 targets 自动引入的 transform plugin 即可，只是有一些特殊场景下可能会用到。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="modules"></a>modules<a class="hash-link" href="#modules" title="Direct link to heading">#</a></h5><p>targets 是指定目标环境，modules 是指定目标模块规范，取值有 amd、umd、systemjs、commonjs (cjs)、auto、false。</p><ul><li><p>amd、umd、systemjs、commonjs (cjs) 这四个分别指定不同的目标模块规范</p></li><li><p>false 是不转换模块规范</p></li><li><p>auto 则是自动探测，默认值也是这个。</p></li></ul><p>其实一般这个 option 都是 bundler 来设置的，因为 bundler 负责模块转换，自然知道要转换成什么模块规范。我们平时就用默认值 auto 即可。</p><p>类似 babel parser 可以设置 moduleType 为 unambiguous，让 babel 根据是否包含 import / export 语法来自动设置为具体的值。 这个 auto 也是一样，会根据探测到的目标环境支持的模块规范来做转换。依据是在 transform 的时候传入的 caller 数据。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">babel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">transformFileSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;example.js&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  caller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;my-custom-tool&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    supportsStaticESM</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>比如在调用 transformFile 的 api 的时候传入了 caller 是支持 esm 的，那么在 targets 的 modules 就会自动设置为 esm。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="debug"></a>debug<a class="hash-link" href="#debug" title="Direct link to heading">#</a></h5><p>debug 这个参数配置比较简单，就是 ture 或者 false，但是意义却很大。我们知道 babel 会根据 targets 支持的特性来过滤 transform plugins 和 polyfills（core-js）。想知道最终使用的 transform plugin 和引入的 core-js 模块是否对，那就可以把 debug 设为 true，这样在控制台打印这些数据。</p><p>比如</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sourceCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">  import &quot;core-js&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">  new Array(5).fill(&#x27;111&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> babel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">transformSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sourceCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;a.mjs&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    targets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        browsers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Chrome 45&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    presets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;@babel/env&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            debug</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            useBuiltIns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;usage&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            corejs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>设置 debug 为 true，会打印 targets 和根据 tragets 过滤出的的 plugin 和 preset：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@babel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">preset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">env</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">DEBUG</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> option</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> targets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;chrome&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;45&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> modules transform</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> auto</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> plugins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">numeric</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">separator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">75</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">logical</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">assignment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">operators </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">85</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nullish</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">coalescing</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">operator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">optional</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">chaining </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">json</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">strings </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">66</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">optional</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">binding </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">66</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">parameters </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">async</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">generator</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">functions </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">object</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rest</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spread </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dotall</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regex </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">62</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">unicode</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">property</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regex </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">named</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">capturing</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">groups</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regex </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">async</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">to</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">generator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exponentiation</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">operator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">52</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">function</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">51</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">arrow</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">functions </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">47</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">classes </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">46</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">object</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">super</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">46</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">51</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sticky</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regex </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">unicode</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regex </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spread </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">46</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">destructuring </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">51</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">block</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scoping </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">new</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">target </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">46</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">regenerator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword module" style="color:#00009f">export</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> chrome </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">72</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transform</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">modules</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">commonjs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  proposal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dynamic</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">corejs3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">DEBUG</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> option</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> targets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;chrome&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;45&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> polyfills </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">usage-global</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">regenerator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">DEBUG</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> option</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> targets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;chrome&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;45&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Using</span><span class="token plain"> polyfills </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">usage-global</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">When</span><span class="token plain"> setting </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">useBuiltIns: &#x27;usage&#x27;</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> polyfills are automatically imported when needed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property-access maybe-class-name">Please</span><span class="token plain"> remove the direct </span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">core-js</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> or use </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">useBuiltIns: &#x27;entry&#x27;</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> instead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Users</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">zhaixuguang</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">code</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">research</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">babel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mjs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Based</span><span class="token plain"> on your code and targets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> the corejs3 polyfill did not add any polyfill</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Users</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">zhaixuguang</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">code</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">research</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">babel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mjs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Based</span><span class="token plain"> on your code and targets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> the regenerator polyfill did not add any polyfill</span><span class="token punctuation" style="color:#393A34">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>用到了哪些插件一目了然，开发时可以开启这个配置项。</p><p>更多配置项可以在<a href="https://babeljs.io/docs/en/babel-preset-env#options" target="_blank" rel="noopener noreferrer">文档中</a>查看。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="从注入到抽离"></a>从注入到抽离<a class="hash-link" href="#从注入到抽离" title="Direct link to heading">#</a></h2><p>preset-env 会在使用到新特性的地方注入 helper 到 AST 中，并且会引入用到的特性的 polyfill （corejs + regenerator），这样会导致两个问题：</p><ul><li>重复注入 helper 的实现，导致代码冗余</li><li>polyfill 污染全局环境</li></ul><p>解决这两个问题的思路就是抽离出来，然后作为模块引入，这样多个模块复用同一份代码就不会冗余了，而且 polyfill 是模块化引入的也不会污染全局环境。</p><p>这个逻辑是在 \@babel/plugin-transform-runtime 包里实现的。它可以把直接注入全局的方式改成模块化引入。</p><p>比如使用 preset-env 的时候是全局引入的：</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ea48ded51f04512bac80b8e4db809cb~tplv-k3u1fbpfcp-watermark.image"></p><p>当引入 \@babel/plugin-transform-runtime 就可以模块化引入：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64df84f32f6945c19bac48cc7185dee7~tplv-k3u1fbpfcp-watermark.image"></p><p>这样就不再污染全局环境了。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="babel7-的问题"></a>babel7 的问题<a class="hash-link" href="#babel7-的问题" title="Direct link to heading">#</a></h3><p>我们先来试验一下：</p><p>看一下 Array.prototype.fill 的环境支持情况：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cae7d0873384728a404963eff4861c4~tplv-k3u1fbpfcp-watermark.image"></p><p>可以看到在 Chrome 45 及以上支持这个特性，而在 Chrome 44 就不支持了。</p><p>我们先单独试一下 preset-env：</p><p>当指定 targets 为 Chrome 44 时，应该自动引入polyfill：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7d43b57304a4d2f9f64af086f5d6098~tplv-k3u1fbpfcp-watermark.image"></p><p>当指定 targets 为 Chrome 45 时，不需要引入polyfill：</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f68b5ad95f644518c8419c1847f7765~tplv-k3u1fbpfcp-watermark.image"></p><p>结果都符合预期，44 引入，45 不引入。</p><p>我们再来试试 \@babel/plugin-transform-runtime：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9677f1aaba654728aec933b31e632fe0~tplv-k3u1fbpfcp-watermark.image"></p><p>是不是发现问题了，Chrome 45 不是支持 Array.prototype.fill 方法么，为啥还是引入了 polyfill。</p><p>因为 babel 中插件的应用顺序是：先 plugin 再 preset，plugin 从左到右，preset 从右到左，这样 plugin-transform-runtime 是在 preset-env 前面的。等 \@babel/plugin-transform-runtime 转完了之后，再交给 preset-env 这时候已经做了无用的转换了。而 \@babel/plugin-transform-runtime 并不支持 targets 的配置，就会做一些多余的转换和 polyfill。</p><p>这个问题在即将到来的 babel8 中得到了解决。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="babel8"></a>babel8<a class="hash-link" href="#babel8" title="Direct link to heading">#</a></h3><p>babel8 提供了 <a href="https://github.com/babel/babel-polyfills" target="_blank" rel="noopener noreferrer">一系列 babel polyfill 的包</a> ，解决了 babel7 的 \@babel/plugin-transform-runtime 的遗留问题，可以通过 targets 来按需精准引入 polyfill。</p><p>babel8 支持配置一个 polyfill provider，也就是说你可以指定 corejs2、corejs3、es-shims 等 polyfill，还可以自定义 polyfil。</p><p>有了 polyfill 源之后，使用 polyfill 的方式也把之前 transform-runtime 做的事情内置了，从之前的 useBuiltIns: entry、 useBuiltIns: usage 的两种，变成了 3 种：</p><ul><li>entry-global: 这个和之前的 useBuiltIns: entry 对标，就是全局引入 polyfill。</li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/202c38690dfe455b8c033d6e54ede9b2~tplv-k3u1fbpfcp-watermark.image"></p><ul><li>usage-entry: 这个和 useBuiltIns: usage 对标，就是具体模块引入用到的 polyfill。</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21d206affa374e53a786592e6a0cfa6e~tplv-k3u1fbpfcp-watermark.image"></p><ul><li>usage-pure：这个就是之前需要 transform-runtime 插件做的事情，使用不污染全局变量的 pure 的方式引入具体模块用到的 polyfill.</li></ul><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51c65f9672d34c04814142bf04ccc8b9~tplv-k3u1fbpfcp-watermark.image"></p><p>其实这三种方式 babel 7 也支持，但是 babel8 不再需要 transform-runtime 插件了，而且还支持了 polyfill provider 的配置。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="思路梳理"></a>思路梳理<a class="hash-link" href="#思路梳理" title="Direct link to heading">#</a></h2><p>babel 的功能都是通过插件完成的，但是直接指定插件太过麻烦，所以设计出了 preset，我们学习 babel 的内置功能基本等价于学习 preset 的使用。主要是 preset-env、preset-typescript 这些。</p><p>但是一些 proposal 的插件需要单独引入，并且 \@babel/plugin-transform-runtime也要单独引入。</p><p>学习内置功能的话 preset 是重点，但是最终完成功能的还是通过插件。小册的重点在于插件上，介绍内置的 preset 只是梳理下 babel 实现编译的思路。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p>上一节我们基于 plugin 和 preset 已经能够完成 esnext 等代码转目标环境 js 代码的功能，但是还不完美。</p><p>这一节我们介绍了 \@babel/preset-env，它基于每种特性的在不同环境的最低支持版本的数据和配置的 targets 来过滤插件，这样能减少很多没必要的转换和 polyfill。</p><p>如果希望把一些公共的 helper、core-js、regenerator 等注入的 runtime 函数抽离出来，并且以模块化的方式引入，那么需要用 \@babel/plugin-transform-runtime 这个包。</p><p>\@babel/plugin-transform-runtime 不支持根据 targets 的过滤，和 \@babel/preset-env 配合时有问题，这个在 babel8 中得到了解决。babel8 提供了很多 babel polyfill 包，支持了 polyfill provider 的配置，而且还可以选择注入方式。不再需要 \@babel/plugin-transform-runtime 插件了。</p><p>学完这一节，我们知道了 babel 如何基于数据做到精准的转换，如何设计 preset，这对我们设计 preset 或许也有一些启发。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/dapengdouyu/docs/tree/master/docs/books/babel/13、Babel 的内置功能（下）.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-10-09T09:56:52.000Z">10/9/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#从目标语言版本到目标浏览器" class="table-of-contents__link">从目标语言版本到目标浏览器</a></li><li><a href="#从注入到抽离" class="table-of-contents__link">从注入到抽离</a><ul><li><a href="#babel7-的问题" class="table-of-contents__link">babel7 的问题</a></li><li><a href="#babel8" class="table-of-contents__link">babel8</a></li></ul></li><li><a href="#思路梳理" class="table-of-contents__link">思路梳理</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 dapeng (张亚鹏) Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3c5dc381.js"></script>
<script src="/assets/js/main.055808b2.js"></script>
</body>
</html>