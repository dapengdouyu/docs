"use strict";(self.webpackChunkdapengdouyu=self.webpackChunkdapengdouyu||[]).push([[6806],{3905:function(n,e,t){t.d(e,{Zo:function(){return c},kt:function(){return d}});var r=t(67294);function l(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function a(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function i(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach((function(e){l(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function o(n,e){if(null==n)return{};var t,r,l=function(n,e){if(null==n)return{};var t,r,l={},a=Object.keys(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||(l[t]=n[t]);return l}(n,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(l[t]=n[t])}return l}var u=r.createContext({}),p=function(n){var e=r.useContext(u),t=e;return n&&(t="function"==typeof n?n(e):i(i({},e),n)),t},c=function(n){var e=p(n.components);return r.createElement(u.Provider,{value:e},n.children)},s={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},m=r.forwardRef((function(n,e){var t=n.components,l=n.mdxType,a=n.originalType,u=n.parentName,c=o(n,["components","mdxType","originalType","parentName"]),m=p(t),d=l,k=m["".concat(u,".").concat(d)]||m[d]||s[d]||a;return t?r.createElement(k,i(i({ref:e},c),{},{components:t})):r.createElement(k,i({ref:e},c))}));function d(n,e){var t=arguments,l=e&&e.mdxType;if("string"==typeof n||l){var a=t.length,i=new Array(a);i[0]=m;var o={};for(var u in e)hasOwnProperty.call(e,u)&&(o[u]=e[u]);o.originalType=n,o.mdxType="string"==typeof n?n:l,i[1]=o;for(var p=2;p<a;p++)i[p]=t[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},49188:function(n,e,t){t.r(e),t.d(e,{frontMatter:function(){return o},contentTitle:function(){return u},metadata:function(){return p},toc:function(){return c},default:function(){return m}});var r=t(83117),l=t(80102),a=(t(67294),t(3905)),i=["components"],o={},u=void 0,p={unversionedId:"books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6",id:"books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6",title:"19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6",description:"\u538b\u7f29\u6df7\u6dc6\u5de5\u5177\u662f\u524d\u7aef\u5fc5\u7528\u7684\u5de5\u5177\u4e4b\u4e00\uff0c\u4ee3\u7801\u5728\u4e0a\u7ebf\u4e4b\u95f4\u9700\u8981\u7ecf\u8fc7\u538b\u7f29\u6765\u51cf\u5c0f\u4f53\u79ef\uff0c\u5e76\u4e14\u4f1a\u505a\u4e00\u4e9b\u7b80\u5355\u7684\u6df7\u6dc6\u6765\u9632\u6b62\u6e90\u7801\u76f4\u63a5\u6cc4\u6f0f\u3002\u524d\u7aef\u5de5\u7a0b\u5e08\u53ef\u80fd\u6bcf\u5929\u90fd\u5728\u7528\u8fd9\u79cd\u5de5\u5177\uff0c\u53ef\u4f60\u6709\u60f3\u8fc7\u5b83\u7684\u5b9e\u73b0\u539f\u7406\u4e48\uff1f",source:"@site/docs/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6.md",sourceDirName:"books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d",slug:"/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6",permalink:"/docs/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6",editUrl:"https://github.com/dapengdouyu/docs/tree/master/docs/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/19\u3001\u5b9e\u6218\u6848\u4f8b: \u538b\u7f29\u6df7\u6dc6.md",tags:[],version:"current",frontMatter:{},sidebar:"books",previous:{title:"18\u3001\u5b9e\u6218\u6848\u4f8b: type checker",permalink:"/docs/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/18\u3001\u5b9e\u6218\u6848\u4f8b: type checker"},next:{title:"20\u3001\u5b9e\u6218\u6848\u4f8b: js \u89e3\u91ca\u5668",permalink:"/docs/books/Babel \u63d2\u4ef6\u901a\u5173\u79d8\u7c4d/20\u3001\u5b9e\u6218\u6848\u4f8b: js \u89e3\u91ca\u5668"}},c=[{value:"\u6df7\u6dc6",id:"\u6df7\u6dc6",children:[{value:"\u601d\u8def\u5206\u6790",id:"\u601d\u8def\u5206\u6790",children:[],level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",children:[],level:3}],level:2},{value:"\u538b\u7f29",id:"\u538b\u7f29",children:[{value:"\u5220\u9664 return \u4e4b\u540e\u7684\u8bed\u53e5",id:"\u5220\u9664-return-\u4e4b\u540e\u7684\u8bed\u53e5",children:[{value:"\u601d\u8def\u5206\u6790",id:"\u601d\u8def\u5206\u6790-1",children:[],level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-1",children:[],level:4}],level:3},{value:"\u5220\u9664\u6ca1\u88ab\u4f7f\u7528\u7684\u53d8\u91cf\u58f0\u660e",id:"\u5220\u9664\u6ca1\u88ab\u4f7f\u7528\u7684\u53d8\u91cf\u58f0\u660e",children:[{value:"\u601d\u8def\u5206\u6790",id:"\u601d\u8def\u5206\u6790-2",children:[],level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-2",children:[],level:4}],level:3}],level:2},{value:"\u6548\u679c\u6f14\u793a",id:"\u6548\u679c\u6f14\u793a",children:[],level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",children:[],level:2}],s={toc:c};function m(n){var e=n.components,t=(0,l.Z)(n,i);return(0,a.kt)("wrapper",(0,r.Z)({},s,t,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u538b\u7f29\u6df7\u6dc6\u5de5\u5177\u662f\u524d\u7aef\u5fc5\u7528\u7684\u5de5\u5177\u4e4b\u4e00\uff0c\u4ee3\u7801\u5728\u4e0a\u7ebf\u4e4b\u95f4\u9700\u8981\u7ecf\u8fc7\u538b\u7f29\u6765\u51cf\u5c0f\u4f53\u79ef\uff0c\u5e76\u4e14\u4f1a\u505a\u4e00\u4e9b\u7b80\u5355\u7684\u6df7\u6dc6\u6765\u9632\u6b62\u6e90\u7801\u76f4\u63a5\u6cc4\u6f0f\u3002\u524d\u7aef\u5de5\u7a0b\u5e08\u53ef\u80fd\u6bcf\u5929\u90fd\u5728\u7528\u8fd9\u79cd\u5de5\u5177\uff0c\u53ef\u4f60\u6709\u60f3\u8fc7\u5b83\u7684\u5b9e\u73b0\u539f\u7406\u4e48\uff1f"),(0,a.kt)("p",null,"\u4ee3\u7801\u7684\u538b\u7f29\u548c\u6df7\u6dc6\u90fd\u662f\u5bf9\u4ee3\u7801\u505a\u8f6c\u6362\uff0c\u4f46\u662f\u8f6c\u6362\u524d\u540e\u8981\u4fdd\u6301\u8bed\u4e49\u4e00\u81f4\uff0c\u5c31\u662f\u4e0d\u80fd\u8f6c\u5b8c\u4e4b\u540e\u4ee3\u7801\u903b\u8f91\u6539\u53d8\u4e86\u3002\u4e4b\u6240\u4ee5\u80fd\u505a\u8fd9\u4e9b\u8f6c\u6362\u662f\u56e0\u4e3a\u8ba1\u7b97\u673a\u6267\u884c\u4ee3\u7801\u5e76\u4e0d\u9700\u8981\u6362\u884c\u3001\u4e5f\u4e0d\u9700\u8981\u53d8\u91cf\u540d\u591a\u4e48\u6613\u61c2\uff0c\u90a3\u90fd\u662f\u7ed9\u4eba\u770b\u7684\uff0c\u53ef\u4ee5\u7b80\u5316\u6389\uff0c\u800c\u4e14\u6709\u7684\u4e0d\u4f1a\u88ab\u6267\u884c\u5230\u7684\u4ee3\u7801\u4e5f\u53ef\u4ee5\u5220\u6389\u3002\u538b\u7f29\u548c\u6df7\u6dc6\u5c31\u662f\u5206\u6790\u4ee3\u7801\u4e2d\u7684\u8fd9\u79cd\u4ee3\u7801\uff0c\u8fdb\u884c\u5206\u6790\u548c\u8f6c\u6362\uff0c\u8fbe\u5230\u8f6c\u6362\u524d\u540e\u6267\u884c\u903b\u8f91\u4e00\u81f4\uff0c\u4f46\u662f\u4ee3\u7801\u4f53\u79ef\u66f4\u5c0f\u3001\u53ef\u8bfb\u6027\u66f4\u5dee\u7684\u76ee\u7684\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u5206\u522b\u6765\u5b9e\u73b0\u4e00\u4e0b\u538b\u7f29\u548c\u6df7\u6dc6\u3002"),(0,a.kt)("h2",{id:"\u6df7\u6dc6"},"\u6df7\u6dc6"),(0,a.kt)("h3",{id:"\u601d\u8def\u5206\u6790"},"\u601d\u8def\u5206\u6790"),(0,a.kt)("p",null,"\u6df7\u6dc6\u5c31\u662f\u628a\u4ee3\u7801\u53d8\u5f97\u96be\u4ee5\u9605\u8bfb\uff0c\u8ba9\u6000\u6709\u6076\u610f\u76ee\u7684\u7684\u4eba\u5f88\u96be\u901a\u8fc7\u4ee3\u7801\u7406\u6e05\u903b\u8f91\uff0c\u4f46\u662f\u4e0d\u80fd\u6539\u53d8\u6267\u884c\u7684\u7ed3\u679c\u3002\u8981\u505a\u7b49\u4ef7\u8f6c\u6362\u3002"),(0,a.kt)("p",null,"\u8fd9\u79cd\u8f6c\u6362\u5305\u62ec\u4e24\u65b9\u9762\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u540d\u5b57\u8f6c\u6362\u3002\u53d8\u91cf\u540d\u3001\u51fd\u6570\u540d\u8fd9\u4e9b\u6211\u4eec\u4f1a\u6ce8\u610f\u547d\u540d\u8981\u6709\u542b\u4e49\uff0c\u4f46\u662f\u7f16\u8bd1\u540e\u7684\u4ee3\u7801\u5c31\u4e0d\u9700\u8981\u4e86\uff0c\u53ef\u4ee5\u628a\u5404\u79cd identifier \u7684 name \u91cd\u547d\u540d\u4e3a\u6ca1\u6709\u542b\u4e49\u7684 abcd\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u901a\u8fc7 path.scope.rename \u7684 api \u6765\u505a\u5230\u3002")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u903b\u8f91\u8f6c\u6362\u3002if \u7684\u903b\u8f91\u53ef\u4ee5\u7528 switch \u6765\u4ee3\u66ff\uff0cfor \u7684\u903b\u8f91\u53ef\u4ee5\u7528 while \u6765\u4ee3\u66ff\uff0c\u8fd9\u90fd\u662f\u7b49\u4ef7\u7684\uff0c\u628a\u4e00\u79cd\u65b9\u5f0f\u5b9e\u73b0\u7684\u4ee3\u7801\u8f6c\u6210\u53e6\u4e00\u79cd\u7b49\u4ef7\u7684\u5f62\u5f0f\u5c31\u53ef\u4ee5\u8fbe\u5230\u6df7\u6dc6\u7684\u76ee\u7684\u3002\u505a\u6df7\u6dc6\u5de5\u5177\u4e3b\u8981\u662f\u8981\u627e\u5230\u8fd9\u79cd\u7b49\u4ef7\u7684\u53d8\u5316\uff0c\u800c\u4e14\u540e\u8005\u4e00\u5b9a\u8981\u7279\u522b\u590d\u6742\u96be\u4ee5\u5206\u6790\uff0c\u7136\u540e\u5b9e\u73b0\u8fd9\u79cd\u8f6c\u6362\uff0c\u5c31\u8fbe\u5230\u4e86\u6df7\u6dc6\u7684\u76ee\u7684\u3002"))),(0,a.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u53ea\u5b9e\u73b0\u4e0b\u540d\u5b57\u7684\u6df7\u6dc6\u3002"),(0,a.kt)("p",null,"\u76ee\u7684\u662f\u4e3a\u4e86\u627e\u51fa\u6240\u6709\u7684\u58f0\u660e\uff0c\u90a3\u5c31\u8981\u904d\u5386\u6240\u6709\u4f1a\u751f\u6210\u4f5c\u7528\u57df\u7684\u8282\u70b9\uff0c\u5305\u62ec FunctionDeclaration\u3001BlockStatement \u7b49\uff0c\u800c\u8fd9\u4e9b\u8282\u70b9\u53c8\u4e00\u4e2a\u522b\u540d\uff0c\u53eb Scopable\uff08\u6240\u6709\u7684\u522b\u540d\u53ef\u4ee5\u5728",(0,a.kt)("a",{parentName:"p",href:"https://github.com/babel/babel/blob/main/packages/babel-types/src/ast-types/generated/index.ts#L2489-L2535"},"\u8fd9\u91cc"),"\u67e5\uff0c\u8be6\u89c1\u7b2c\u4e03\u8282\uff09\uff0c\u7136\u540e\u5bf9\u6bcf\u4e00\u4e2a\u58f0\u660e\uff08binding\uff09\u90fd\u91cd\u547d\u540d\u4e3a\u65e0\u610f\u4e49\u7684\u540d\u5b57\uff0c\u5e76\u4e14\u66f4\u65b0\u6240\u6709\u5f15\u7528\u8fd9\u4e2a\u58f0\u660e\u7684\u5730\u65b9\uff0c\u8fd9\u4e2a\u903b\u8f91\u5728 path.scope.rename \u5df2\u7ecf\u5b9e\u73b0\u4e86\uff0c\u76f4\u63a5\u8c03\u7528\u8fd9\u4e2a api \u5373\u53ef\u3002"),(0,a.kt)("h3",{id:"\u4ee3\u7801\u5b9e\u73b0"},"\u4ee3\u7801\u5b9e\u73b0"),(0,a.kt)("p",null,"\u4f9d\u7136\u5148\u5199\u597d\u63d2\u4ef6\u7684\u7ed3\u6784\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"const { declare } = require('@babel/helper-plugin-utils');\n\nconst mangle = declare((api, options, dirname) => {\n    api.assertVersion(7);\n\n    return {\n        pre(file) {\n            file.set('uid', 0);\n        },\n        visitor: {\n            Scopable: {\n               \n            }\n        }\n    }\n});\n\nmodule.exports = mangle;\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u5728 file \u653e\u4e86\u4e00\u4e2a uid \u662f\u4e3a\u4e86\u83b7\u53d6\u552f\u4e00 id \u7684\uff0c\u540e\u9762\u4f1a\u7528\u5230\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u57fa\u4e8e\u8fd9\u4e2a uid \u6765\u83b7\u53d6\u552f\u4e00\u7684\u540d\u5b57\uff0c\u56e0\u4e3a\u4e0d\u80fd\u4ee5\u6570\u5b57\u5f00\u5934\uff0c\u6240\u4ee5\u7528 A-Z\u3001a-z\u3001","$"," \u548c ","_"," \u8fd9 54 \u4e2a\u5b57\u7b26\u6765\u751f\u6210\u3002"),(0,a.kt)("p",null,"\u6839\u636e\u4f20\u5165\u7684 num \u6765\u53d6\u5bf9\u5e94\u4e0b\u6807\u7684\u5b57\u7b26\u7ec4\u6210\u5b57\u7b26\u4e32\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'const base54 = (function(){\n    var DIGITS = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_";\n    return function(num) {\n            var ret = "";\n            do {\n                    ret = DIGITS.charAt(num % 54) + ret;\n                    num = Math.floor(num / 54);\n            } while (num > 0);\n            return ret;\n    };\n})();\n')),(0,a.kt)("p",null,"\u7136\u540e\u5c31\u662f\u66ff\u6362\u6240\u6709\u7684\u58f0\u660e\uff08binding\uff09 \u7684\u540d\u5b57\u4e86\uff1a"),(0,a.kt)("p",null,"\u9996\u5148\u53d6\u51fa path.scope.bindings\uff0c\u904d\u5386\u6bcf\u4e00\u4e2a binding\uff0c\u7136\u540e\u901a\u8fc7 rename \u7684 api \u6765\u8fdb\u884c\u6539\u540d\u3002"),(0,a.kt)("p",null,"\u5e76\u4e14\u5904\u7406\u8fc7\u540e\u7684\u58f0\u660e\u52a0\u4e2a\u6807\u8bb0\uff0c\u518d\u6b21\u5904\u7406\u5230\u7684\u65f6\u5019\u5c31\u8df3\u8fc7\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Scopable: {\n    exit(path, state) {\n        let uid = state.file.get('uid');\n        Object.entries(path.scope.bindings).forEach(([key, binding]) => {\n            if(binding.mangled) return;\n            binding.mangled = true;\n            const newName = path.scope.generateUid(base54(uid++));\n            binding.path.scope.rename(key, newName)\n        });\n        state.file.set('uid', uid);\n    }\n}\n")),(0,a.kt)("p",null,"\u8bd5\u4e0b\u6548\u679c\uff0c\u5f53\u8f93\u5165\u4ee3\u7801\u4e3a\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function func() {\n    const num1 = 1;\n    const num2 = 2;\n    const num3 = /*@__PURE__*/add(1, 2);\n    const num4 = add(3, 4);\n    console.log(num2);\n    return num2;\n    console.log(num1);\n    function add (aaa, bbb) {\n        return aaa + bbb;\n    }\n}\nfunc();\n")),(0,a.kt)("p",null,"\u8f93\u51fa\u4e3a\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/596e2ff12a5b426e9ff0665cee7827a6~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,a.kt)("p",null,"\u81f3\u6b64\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u53d8\u91cf\u540d\u7684\u6df7\u6dc6\uff01"),(0,a.kt)("h2",{id:"\u538b\u7f29"},"\u538b\u7f29"),(0,a.kt)("p",null,"\u538b\u7f29\u5c31\u662f\u8981\u53bb\u6389\u4ee3\u7801\u4e2d\u6267\u884c\u4e0d\u5230\u7684\u90e8\u5206\uff0c\u6bd4\u5982 return \u8bed\u53e5\u540e\u7684\u4e00\u4e9b\u8bed\u53e5\u548c\u6ca1\u6709\u610f\u4e49\u7684\u90e8\u5206\uff0c\u6bd4\u5982\u6ce8\u91ca\u3001\u6362\u884c\u7b49\u3002"),(0,a.kt)("p",null,"\u57fa\u4e8e AST \u7684\u8f6c\u6362\u505a\u538b\u7f29\u8981\u5904\u7406\u7684\u60c5\u51b5\u7279\u522b\u591a\uff0c\u8fd9\u91cc\u6211\u4eec\u53ea\u5b9e\u73b0\u4e24\u79cd\u60c5\u51b5\u7684\u538b\u7f29\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5220\u9664 return \u4e4b\u540e\u7684\u4e0d\u4f1a\u6267\u884c\u5230\u7684\u8bed\u53e5"),(0,a.kt)("li",{parentName:"ul"},"\u5220\u9664\u6ca1\u6709\u88ab\u4f7f\u7528\u7684\u53d8\u91cf\u58f0\u660e\uff08\u6b7b\u4ee3\u7801\u5220\u9664 Dead Code Elemation\uff0c\u7b80\u79f0 DCE\uff09")),(0,a.kt)("h3",{id:"\u5220\u9664-return-\u4e4b\u540e\u7684\u8bed\u53e5"},"\u5220\u9664 return \u4e4b\u540e\u7684\u8bed\u53e5"),(0,a.kt)("h4",{id:"\u601d\u8def\u5206\u6790-1"},"\u601d\u8def\u5206\u6790"),(0,a.kt)("p",null,"\u5220\u9664 return \u4e4b\u540e\u7684\u8bed\u53e5\uff0c\u5c31\u662f\u8981\u627e\u5230\u51fd\u6570\u58f0\u660e FunctionDeclaration \u7684\u51fd\u6570\u4f53\uff0c\u904d\u5386\u4e00\u904d body \u7684 AST\uff0c\u5982\u679c\u662f return \u4e4b\u540e\u5c31\u6253\u4e2a\u6807\u8bb0\u4e4b\u540e\u5220\u9664\u3002"),(0,a.kt)("p",null,"\u4f46\u662f\u8981\u6ce8\u610f\uff0creturn \u4e4b\u540e\u662f\u53ef\u4ee5\u6709\u51fd\u6570\u58f0\u660e\u7684\uff0c\u4f1a\u505a\u53d8\u91cf\u63d0\u5347\uff0c\u8fd8\u6709\u5982\u679c\u662f var \u58f0\u660e\u7684\u53d8\u91cf\uff0c\u4e5f\u4f1a\u505a\u63d0\u5347\uff0c\u6240\u4ee5\u8981\u53bb\u6389\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002"),(0,a.kt)("h4",{id:"\u4ee3\u7801\u5b9e\u73b0-1"},"\u4ee3\u7801\u5b9e\u73b0"),(0,a.kt)("p",null,"\u62ff\u5230 BlockStatement \u7684 body \u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\uff0c\u5982\u679c\u662f\u5728 return\u3001throw \u7b49\u8bed\u53e5\u4e4b\u540e\uff0c\u5c31\u51c6\u5907\u5220\u9664\uff0c\u4f46\u662f\u8981\u6392\u9664\u51fd\u6570\u58f0\u660e\u8bed\u53e5\u548c var \u7684\u53d8\u91cf\u58f0\u660e\u8bed\u53e5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"BlockStatement(path) {\n    const statementPaths = path.get('body');\n    let purge = false;\n    for (let i = 0; i < statementPaths.length; i++) {\n\n        if (statementPaths[i].isCompletionStatement()) {\n            purge = true;\n            continue;\n        }\n\n        if (purge && !canExistAfterCompletion(statementPaths[i])) {\n            statementPaths[i].remove();\n        } \n    }\n}\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684 CompletionStatement \u53ef\u4ee5\u901a\u8fc7\u524d\u9762\u63d0\u5230\u7684 alias \u6765\u67e5\uff0c CompletionStatement \u4e5f\u662f\u4e00\u4e2a\u522b\u540d\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bd81f8022394c8999ff9f4e5b68428b~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,a.kt)("p",null,"\u7136\u540e\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u5220\u9664\u7684 canExistAfterCompletion \u65b9\u6cd5\u662f\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'function canExistAfterCompletion(path) {\n    return path.isFunctionDeclaration() || path.isVariableDeclaration({\n        kind: "var"\n    });\n}\n')),(0,a.kt)("p",null,"\u6d4b\u8bd5\u4e0b\u6548\u679c\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd80d95d600d4526940da936e91071cf~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,a.kt)("p",null,"\u8fd9\u6837\u5c31\u8fbe\u5230\u4e86\u5220\u9664\u4e0d\u4f1a\u6267\u884c\u5230\u7684\u4ee3\u7801\u7684\u76ee\u7684\u3002"),(0,a.kt)("h3",{id:"\u5220\u9664\u6ca1\u88ab\u4f7f\u7528\u7684\u53d8\u91cf\u58f0\u660e"},"\u5220\u9664\u6ca1\u88ab\u4f7f\u7528\u7684\u53d8\u91cf\u58f0\u660e"),(0,a.kt)("h4",{id:"\u601d\u8def\u5206\u6790-2"},"\u601d\u8def\u5206\u6790"),(0,a.kt)("p",null,"\u53d8\u91cf\u58f0\u660e\u4e5f\u5c31\u662f path.scope \u4e2d\u7684 binding\uff0c\u53ef\u4ee5\u901a\u8fc7 references \u7684\u6570\u91cf\u6216\u8005 referenced \u662f\u5426\u662f true \u6765\u5224\u65ad\u662f\u5426\u88ab\u5f15\u7528\uff0c\u5982\u679c\u6ca1\u6709\u88ab\u5f15\u7528\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u5220\u9664\u3002"),(0,a.kt)("p",null,"\u4f46\u662f\u8fd9\u91cc\u4e5f\u6709\u79cd\u7279\u6b8a\u60c5\u51b5\uff0c\u5c31\u662f\u5982\u679c\u521d\u59cb\u5316\u7684\u503c\u662f\u51fd\u6570\u8c03\u7528\uff0c\u90a3\u4e48\u5c31\u4e0d\u80fd\u76f4\u63a5\u5220\u9664\uff0c\u56e0\u4e3a\u53ef\u80fd\u6709\u526f\u4f5c\u7528\uff0c\u6bd4\u5982\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function a {\n    console.log('a');\n    return 'aa';\n}\n\nconst b = a();\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684 b \u6ca1\u6709\u88ab\u7528\u5230\uff0c\u4f46\u662f\u8fd9\u4e2a a","(",")"," \u7684\u51fd\u6570\u8c03\u7528\u5374\u4e0d\u80fd\u76f4\u63a5\u5220\u9664\uff0c\u56e0\u4e3a\u662f\u6709\u526f\u4f5c\u7528\u7684\uff0c\u53ea\u80fd\u8f6c\u6210\u8fd9\u79cd\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function a {\n    console.log('a');\n    return 'aa';\n}\n\na();\n")),(0,a.kt)("p",null,"\u53ea\u628a\u58f0\u660e\u7684\u53d8\u91cf\u53bb\u6389\uff0c\u4f46\u662f\u4fdd\u7559\u51fd\u6570\u8c03\u7528\u8bed\u53e5\u3002"),(0,a.kt)("p",null,"\u90a3\u4e48\u5982\u679c\u8be5\u8282\u70b9\u786e\u5b9e\u6ca1\u6709\u526f\u4f5c\u7528\u600e\u4e48\u529e\u5462\uff1f"),(0,a.kt)("p",null,"babel \u63d0\u4f9b\u4e86\u4e00\u4e2a path.scope.isPure \u7684 api\uff0c\u53ef\u4ee5\u5224\u65ad\u4e00\u4e9b AST \u8282\u70b9\u662f\u5426\u662f\u7eaf\u7684\uff0c\u4e5f\u5c31\u662f\u662f\u5426\u662f\u6ca1\u6709\u526f\u4f5c\u7528\u7684\uff0c\u53ef\u4ee5\u5224\u65ad\u5404\u79cd AST \u662f\u5426\u53ef\u4ee5\u653e\u5fc3\u7684\u5220\u9664\u3002"),(0,a.kt)("p",null,"\u4f46\u662f\u51fd\u6570\u8c03\u7528\u4ed6\u662f\u5206\u6790\u4e0d\u4e86\u7684\uff0c\u53ef\u4ee5\u91c7\u7528 terser \u7684\u65b9\u6848\uff0c\u901a\u8fc7\u6ce8\u91ca\u6765\u6807\u6ce8\u7eaf\u51fd\u6570\u3002"),(0,a.kt)("p",null,"\u5927\u5bb6\u53ef\u80fd\u89c1\u5230\u8fc7\u8fd9\u6837\u7684\u4ee3\u7801\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," /*#__PURE__*/ React.creatElement('div');\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684 pure \u6ce8\u91ca\u5c31\u662f\u544a\u8bc9 terser \u8fd9\u4e2a\u51fd\u6570\u6ca1\u6709\u526f\u4f5c\u7528\uff0c\u5982\u679c\u6ca1\u7528\u5230\u5c31\u76f4\u63a5\u5220\u9664\u5c31\u884c\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u8fd9\u91cc\u4e5f\u91c7\u7528\u76f8\u540c\u7684\u65b9\u6848\uff0c\u5982\u679c\u51fd\u6570\u8c03\u7528\u4e4b\u524d\u6709 PURE \u6ce8\u91ca\uff0c\u5219\u76f4\u63a5\u5220\u9664\uff0c\u5426\u5219\u4fdd\u7559\u3002"),(0,a.kt)("h4",{id:"\u4ee3\u7801\u5b9e\u73b0-2"},"\u4ee3\u7801\u5b9e\u73b0"),(0,a.kt)("p",null,"\u9996\u5148\u62ff\u5230\u6bcf\u4e00\u4e2a binding\uff0c\u5224\u65ad\u4e0b\u6709\u6ca1\u6709\u88ab\u5f15\u7528\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u6ca1\u6709\u88ab\u5f15\u7528\uff0c\u90a3\u5c31\u5224\u65ad\u4e0b\u521d\u59cb\u5316\u503c\u662f\u5426\u662f\u51fd\u6570\u8c03\u7528\u8bed\u53e5\uff0c\u5982\u679c\u662f\uff0c\u8fd8\u8981\u5224\u65ad\u6709\u6ca1\u6709 PURE \u7684\u6ce8\u91ca\uff0c\u6709\u5c31\u76f4\u63a5\u5220\u3002"),(0,a.kt)("p",null,"\u7136\u540e\u7528 isPure \u5224\u65ad\u8282\u70b9\u662f\u5426\u662f\u6ca1\u6709\u526f\u4f5c\u7528\u7684\uff0c\u6bd4\u5982 StringLiteral\u3001Identifer \u8fd9\u79cd\u5c31\u6ca1\u526f\u4f5c\u7528\uff0c\u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u3002\u5426\u5219\u5c31\u4fdd\u7559\u53f3\u8fb9\u7684\u90e8\u5206\uff0c\u628a\u58f0\u660e\u5220\u9664\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Scopable(path) {\n      Object.entries(path.scope.bindings).forEach(([key, binding]) => {\n            if (!binding.referenced) {//\u6ca1\u6709\u88ab\u5f15\u7528\n                if (binding.path.get('init').isCallExpression()) {\n                    const comments = binding.path.get('init').node.leadingComments;//\u62ff\u5230\u8282\u70b9\u524d\u7684\u6ce8\u91ca\n                    if(comments && comments[0]) {\n                        if (comments[0].value.includes('PURE')) {//\u6709 PURE \u6ce8\u91ca\u5c31\u5220\u9664\n                            binding.path.remove();\n                            return;\n                        }\n                    }\n                }\n                if (!path.scope.isPure(binding.path.node.init)) {//\u5982\u679c\u662f\u7eaf\u7684\uff0c\u5c31\u76f4\u63a5\u5220\u9664\uff0c\u5426\u5219\u66ff\u6362\u4e3a\u53f3\u8fb9\u90e8\u5206\n                    binding.path.parentPath.replaceWith(api.types.expressionStatement(binding.path.node.init));\n                } else {\n                    binding.path.remove();\n                }\n            }\n        });\n    }\n}\n")),(0,a.kt)("p",null,"\u8bd5\u4e0b\u6548\u679c\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8294becd00341c9b0d4e9b22f2ab25e~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,a.kt)("p",null,"\u5982\u56fe\uff0cnum3 \u548c num4 \u90fd\u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u4f46\u662f num3\u56e0\u4e3a\u6807\u8bb0\u4e86 PURE\uff0c\u6240\u4ee5\u5f53\u4f5c\u7eaf\u51fd\u6570\u5220\u9664\u4e86\uff0c\u800c num4 \u5219\u4fdd\u7559\u4e86\u8be5\u51fd\u6570\u8c03\u7528\u3002"),(0,a.kt)("h2",{id:"\u6548\u679c\u6f14\u793a"},"\u6548\u679c\u6f14\u793a"),(0,a.kt)("p",null,"\u6211\u4eec\u628a\u538b\u7f29\u548c\u6df7\u6dc6\u7684\u529f\u80fd\u6574\u4f53\u8dd1\u4e00\u4e0b:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"const { transformFromAstSync } = require('@babel/core');\nconst  parser = require('@babel/parser');\nconst manglePlugin = require('./plugin/mangle');\nconst compressPlugin = require('./plugin/compress');\n\nconst sourceCode = `\n    function func() {\n        const num1 = 1;\n        const num2 = 2;\n        const num3 = /*@__PURE__*/add(1, 2);\n        const num4 = add(3, 4);\n        console.log(num2);\n        return num2;\n        console.log(num1);\n        function add (aaa, bbb) {\n            return aaa + bbb;\n        }\n    }\n    func();\n`;\n\nconst ast = parser.parse(sourceCode, {\n    sourceType: 'unambiguous',\n    comments: true\n});\n\nconst { code } = transformFromAstSync(ast, sourceCode, {\n    plugins: [\n        [manglePlugin], \n        [compressPlugin]\n    ],\n    generatorOpts: {\n        comments: false,\n        compact: true\n    }\n});\nconsole.log(code);\n")),(0,a.kt)("p",null,"\u6548\u679c\u4e3a\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a1edefa3de4b4cb9939cf795918514a1~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,a.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,a.kt)("p",null,"\u538b\u7f29\u6df7\u6dc6\u4e5f\u662f\u5bf9\u4ee3\u7801\u505a\u8f6c\u6362\uff0c\u4f46\u662f\u505a\u7684\u662f\u7b49\u4ef7\u8f6c\u6362\uff0c\u53d8\u91cf\u540d\u6362\u6210\u65e0\u610f\u4e49\u7684\u540d\u5b57\uff0c\u4ee3\u7801\u7ed3\u6784\u8f6c\u6210\u66f4\u96be\u8bfb\u4f46\u662f\u6267\u884c\u6548\u679c\u4e00\u6837\u7684\u5f62\u5f0f\uff0c\u6ca1\u7528\u5230\u7684\u4ee3\u7801\uff08return \u540e\u7684\u3001\u6ca1\u88ab\u5f15\u7528\u7684\u58f0\u660e\uff09\u5220\u9664\u6389\u3002\u7b49\u7b49\u3002"),(0,a.kt)("p",null,"\u5177\u4f53\u7684 case \u53ef\u80fd\u5f88\u591a\uff0c\u4f46\u662f\u601d\u8def\u548c\u76ee\u7684\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u5c31\u662f\u5728\u7b49\u4ef7\u7684\u524d\u63d0\u4e0b\uff0c\u8ba9\u4ee3\u7801\u4f53\u79ef\u66f4\u5c0f\uff0c\u53ef\u8bfb\u6027\u66f4\u5dee\u3002"),(0,a.kt)("p",null,"\u6709\u4e9b\u8981\u5bf9\u4ee3\u7801\u505a\u4fdd\u62a4\u7684\u573a\u666f\u662f\u8981\u81ea\u5df1\u505a\u6df7\u6dc6\u7684\u5b9e\u73b0\u7684\uff0c\u5c31\u662f\u8981\u627e\u5404\u79cd\u7b49\u4ef7\u7684\u5f62\u5f0f\uff0c\u7136\u540e\u5b9e\u73b0\u8f6c\u6362\u3002\u9664\u4e86\u8fd9\u4e2a\u4e4b\u5916\uff0c\u4e86\u89e3\u538b\u7f29\u6df7\u6dc6\u7684\u539f\u7406\u4e5f\u53ef\u4ee5\u8ba9\u6211\u4eec\u66f4\u597d\u7684\u4f7f\u7528\u7c7b\u4f3c\u5de5\u5177\uff0c\u6bd4\u5982 terser\u3002"),(0,a.kt)("p",null,"\uff08\u4ee3\u7801\u5728",(0,a.kt)("a",{parentName:"p",href:"https://github.com/QuarkGluonPlasma/babel-plugin-exercize"},"\u8fd9\u91cc"),"\uff0c\u5efa\u8bae git clone \u4e0b\u6765\u901a\u8fc7 node \u8dd1\u4e00\u4e0b\uff09"))}m.isMDXComponent=!0}}]);